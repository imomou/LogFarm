{  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Create DynamoDb table to store Elmah Logs and CloudWatch for Nlog",
   "Parameters":{  
      "ElmahTableName":{  
         "Description":"Name of DynamoDb table will be use to store Elmah logs",
         "Type":"String",
         "Default":"Elmah"
      },
      "NLogGroupName":{  
         "Description":"Name of LogGroup will be use for storing NLog logs",
         "Type":"String",
         "Default":"NLog"
      },
      "ReadWriteCapacityUnits":{  
         "Description":"Name of Elmah table will be created in DynamoDb",
         "Type":"String",
         "Default":"1"
      }
   },
   "Resources":{  
      "ElmahTable":{  
         "Type":"AWS::DynamoDB::Table",
         "Properties":{  
            "AttributeDefinitions":[  
               {  
                  "AttributeName":"DateTimeId",
                  "AttributeType":"S"
               },
               {  
                  "AttributeName":"ApplicationName",
                  "AttributeType":"S"
               }
            ],
            "StreamSpecification":{  
               "StreamViewType":"NEW_IMAGE"
            },
            "KeySchema":[  
               {  
                  "AttributeName":"DateTimeId",
                  "KeyType":"HASH"
               }
            ],
            "ProvisionedThroughput":{  
               "ReadCapacityUnits":{  
                  "Ref":"ReadWriteCapacityUnits"
               },
               "WriteCapacityUnits":{  
                  "Ref":"ReadWriteCapacityUnits"
               }
            },
            "TableName":{  
               "Fn::Join":[  
                  "-",
                  [  
                     {  
                        "Ref":"AWS::StackName"
                     },
                     {  
                        "Ref":"ElmahTableName"
                     }
                  ]
               ]
            },
            "GlobalSecondaryIndexes":[  
               {  
                  "IndexName":"ApplicationName-DateTimeId-Index",
                  "KeySchema":[  
                     {  
                        "AttributeName":"ApplicationName",
                        "KeyType":"HASH"
                     },
                     {  
                        "AttributeName":"DateTimeId",
                        "KeyType":"RANGE"
                     }
                  ],
                  "Projection":{  
                     "ProjectionType":"ALL"
                  },
                  "ProvisionedThroughput":{  
                     "ReadCapacityUnits":{  
                        "Ref":"ReadWriteCapacityUnits"
                     },
                     "WriteCapacityUnits":{  
                        "Ref":"ReadWriteCapacityUnits"
                     }
                  }
               }
            ]
         }
      },
      "NLogGroup":{  
         "Type":"AWS::Logs::LogGroup",
         "Properties":{  
            "LogGroupName":{  
               "Fn::Join":[  
                  "-",
                  [  
                     {  
                        "Ref":"AWS::StackName"
                     },
                     {  
                        "Ref":"NLogGroupName"
                     }
                  ]
               ]
            }
         }
      },
      "NLogGroupCSub":{  
         "DependsOn":[  
            "LogStream",
            "LogStreamRole",
            "LogStreamRolePolicy"
         ],
         "Type":"AWS::Logs::SubscriptionFilter",
         "Condition":"Subscribe",
         "Properties":{  
            "DestinationArn":{  
               "Fn::GetAtt":[  
                  "LogStream",
                  "Arn"
               ]
            },
            "FilterPattern":"",
            "LogGroupName":{  
               "Ref":"NLogGroup"
            },
            "RoleArn":{  
               "Fn::GetAtt":[  
                  "LogStreamRole",
                  "Arn"
               ]
            }
         }
      },
      "LogFarmMp":{  
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{  
            "Description":"Permission for LogFarm related services.",
            "Path":"/generic/logfarm/",
            "PolicyDocument":{  
               "Version":"2012-10-17",
               "Statement":[  
                  {  
                     "Effect":"Allow",
                     "Action":[  
                        "logs:*"
                     ],
                     "Resource":[  
                        {  
                           "Fn::Join":[  
                              "",
                              [  
                                 "arn:aws:logs:*:*:",
                                 {  
                                    "Ref":"NLogGroup"
                                 }
                              ]
                           ]
                        },
                        {  
                           "Fn::Join":[  
                              "",
                              [  
                                 "arn:aws:logs:*:*:",
                                 {  
                                    "Ref":"NLogGroup"
                                 },
                                 ":log-stream:*"
                              ]
                           ]
                        }
                     ]
                  },
                  {  
                     "Effect":"Deny",
                     "Action":[  
                        "logs:deleteLogGroup"
                     ],
                     "Resource":[  
                        {  
                           "Fn::Join":[  
                              "",
                              [  
                                 "arn:aws:logs:*:*:",
                                 {  
                                    "Ref":"NLogGroup"
                                 }
                              ]
                           ]
                        },
                        {  
                           "Fn::Join":[  
                              "",
                              [  
                                 "arn:aws:logs:*:*:",
                                 {  
                                    "Ref":"NLogGroup"
                                 },
                                 ":log-stream:*"
                              ]
                           ]
                        }
                     ]
                  },
                  {  
                     "Action":[  
                        "dynamodb:DeleteTable"
                     ],
                     "Effect":"Allow",
                     "Resource":[  
                        {  
                           "Fn::Join":[  
                              "",
                              [  
                                 "arn:aws:dynamodb:*:*:table/",
                                 {  
                                    "Ref":"ElmahTable"
                                 }
                              ]
                           ]
                        },
                        {  
                           "Fn::Join":[  
                              "",
                              [  
                                 "arn:aws:dynamodb:*:*:table/",
                                 {  
                                    "Ref":"ElmahTable"
                                 },
                                 "/index/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            }
         }
      },
      "LogStream":{  
         "Type":"AWS::Kinesis::Stream",
         "Properties":{  
            "ShardCount":1
         }
      },
      "LogStreamRole":{  
         "Type":"AWS::IAM::Role",
         "Properties":{  
            "AssumeRolePolicyDocument":{  
               "Version":"2012-10-17",
               "Statement":[  
                  {  
                     "Effect":"Allow",
                     "Principal":{  
                        "Service":{  
                           "Fn::Join":[  
                              "",
                              [  
                                 "logs.",
                                 {  
                                    "Ref":"AWS::Region"
                                 },
                                 ".amazonaws.com"
                              ]
                           ]
                        }
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            }
         }
      },
      "LogStreamRolePolicy":{  
         "Type":"AWS::IAM::Policy",
         "Properties":{  
            "PolicyName":"KinesisPutRecordPolicy",
            "Roles":[  
               {  
                  "Ref":"LogStreamRole"
               }
            ],
            "PolicyDocument":{  
               "Version":"2012-10-17",
               "Statement":[  
                  {  
                     "Effect":"Allow",
                     "Action":"kinesis:PutRecord",
                     "Resource":{  
                        "Fn::GetAtt":[  
                           "LogStream",
                           "Arn"
                        ]
                     }
                  },
                  {  
                     "Effect":"Allow",
                     "Action":"iam:PassRole",
                     "Resource":{  
                        "Fn::Join":[  
                           "",
                           [  
                              "arn:aws:iam::",
                              {  
                                 "Ref":"AWS::AccountId"
                              },
                              ":role/",
                              {  
                                 "Ref":"LogStreamRole"
                              }
                           ]
                        ]
                     }
                  }
               ]
            }
         }
      }
   },
   "Outputs":{  

   }
}
